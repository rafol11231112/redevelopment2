<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RE DEVELOPMENT - Admin Panel</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="admin-body">
    <nav class="admin-nav">
        <div class="admin-logo">
            RE <span class="logo-development">DEVELOPMENT</span>
            <span class="admin-badge">Admin Panel</span>
        </div>
        <div class="admin-controls">
            <button class="theme-toggle">
                <i class="fas fa-palette"></i>
            </button>
            <button id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </button>
        </div>
    </nav>
    
    <div class="admin-container">
        <div class="admin-sidebar">
            <div class="sidebar-header">
                <div class="admin-profile">
                    <div class="profile-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="profile-info">
                        <h3>Administrator</h3>
                        <p>Super Admin</p>
                    </div>
                </div>
            </div>
            <div class="sidebar-menu">
                <button class="active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i>
                    Dashboard
                </button>
                <button data-section="projects">
                    <i class="fas fa-project-diagram"></i>
                    Projects
                </button>
                <button data-section="add-project">
                    <i class="fas fa-plus-circle"></i>
                    Add Project
                </button>
                <button data-section="settings">
                    <i class="fas fa-cog"></i>
                    Settings
                </button>
            </div>
        </div>
        
        <div class="admin-content">
            <div id="dashboard" class="admin-section active">
                <div class="dashboard-header">
                    <h2>Dashboard Overview</h2>
                    <div class="date-filter">
                        <button class="active">Today</button>
                        <button>Week</button>
                        <button>Month</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Projects</h3>
                            <p id="totalProjects">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Total Views</h3>
                            <p>1,234</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3>Active Projects</h3>
                            <p id="activeProjects">0</p>
                        </div>
                    </div>
                </div>
                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="recentActivity">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </div>
            
            <div id="projects" class="admin-section">
                <div class="section-header">
                    <h2>Manage Projects</h2>
                    <div class="header-actions">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="projectSearch" placeholder="Search projects...">
                        </div>
                        <button class="add-btn" onclick="document.querySelector('[data-section=\'add-project\']').click()">
                            <i class="fas fa-plus"></i>
                            New Project
                        </button>
                    </div>
                </div>
                <div class="projects-grid" id="projectsList">
                    <!-- Projects will be loaded here -->
                </div>
            </div>
            
            <div id="add-project" class="admin-section">
                <div class="section-header">
                    <h2>Add New Project</h2>
                </div>
                <form id="addProjectForm" class="project-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project Title</label>
                            <input type="text" name="title" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select name="category" required>
                                <option value="software">Software Development</option>
                                <option value="web">Web Development</option>
                                <option value="mobile">Mobile App</option>
                                <option value="design">UI/UX Design</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Project Link (Optional)</label>
                            <input type="url" name="link" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label>Technology Stack</label>
                            <input type="text" name="technology" placeholder="e.g., React, Node.js, MongoDB">
                        </div>
                        <div class="form-group full-width">
                            <label>Description</label>
                            <textarea name="description" required></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label>Detailed Description</label>
                            <textarea name="detailedDescription" rows="6" placeholder="Provide a detailed description of the project..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label>Project Images</label>
                            <div class="file-upload">
                                <input type="file" name="images" multiple accept="image/*" required>
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>Drag & Drop files or Click to upload</span>
                                </div>
                            </div>
                            <div class="image-preview"></div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="cancel-btn">Cancel</button>
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-plus"></i>
                            Add Project
                        </button>
                    </div>
                </form>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="admin-section">
                <div class="section-header">
                    <h2>Settings</h2>
                </div>
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>General Settings</h3>
                        <div class="setting-item">
                            <label>Site Name</label>
                            <input type="text" value="RE DEVELOPMENT">
                        </div>
                        <div class="setting-item">
                            <label>Contact Email</label>
                            <input type="email" value="info@redevelopment.com">
                        </div>
                    </div>
                    <div class="settings-card">
                        <h3>Appearance</h3>
                        <div class="setting-item">
                            <label>Theme</label>
                            <select>
                                <option value="default">Default</option>
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-card">
                        <h3>Security</h3>
                        <div class="setting-item">
                            <label>Change Password</label>
                            <button class="change-password-btn">
                                <i class="fas fa-key"></i>
                                Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this script at the bottom of admin-panel.html before </body> -->
    <script>
        // Project Management
        const projectsList = document.getElementById('projectsList');
        const addProjectForm = document.getElementById('addProjectForm');
        let projects = JSON.parse(localStorage.getItem('projects') || '[]');

        // Make editProject and deleteProject functions global
        window.editProject = async function(id) {
            const project = projects.find(p => p.id === id);
            if (project) {
                document.querySelector('[data-section="add-project"]').click();
                
                // Fill form with project data
                addProjectForm.querySelector('[name="title"]').value = project.title;
                addProjectForm.querySelector('[name="category"]').value = project.category;
                addProjectForm.querySelector('[name="description"]').value = project.description;
                
                // Update form for editing
                addProjectForm.dataset.editing = id;
                document.querySelector('.submit-btn').innerHTML = '<i class="fas fa-save"></i> Update Project';
                
                // Remove required attribute from image input when editing
                addProjectForm.querySelector('[name="images"]').removeAttribute('required');

                // Show existing images
                const imagePreview = addProjectForm.querySelector('.image-preview');
                imagePreview.innerHTML = project.images.map((img, index) => `
                    <div class="preview-image" data-original-image="${img}">
                        <img src="${img}" alt="Preview">
                        <button type="button" class="remove-image" onclick="removeImage(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }
        };

        window.deleteProject = async function(id) {
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    const response = await fetch('/api/projects/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id })
                    });

                    if (!response.ok) throw new Error('Failed to delete project');

                    showNotification('Project deleted successfully!', 'success');
                    await loadProjects();
                } catch (error) {
                    console.error('Error deleting project:', error);
                    showNotification('Error deleting project', 'error');
                }
            }
        };

        // Add click handlers for sidebar navigation
        document.querySelectorAll('.sidebar-menu button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons and sections
                document.querySelectorAll('.sidebar-menu button').forEach(btn => 
                    btn.classList.remove('active'));
                document.querySelectorAll('.admin-section').forEach(section => 
                    section.classList.remove('active'));
                
                // Add active class to clicked button and corresponding section
                button.classList.add('active');
                const sectionId = button.getAttribute('data-section');
                document.getElementById(sectionId).classList.add('active');
            });
        });

        // Add click handler for cancel button
        document.querySelector('.cancel-btn').addEventListener('click', () => {
            addProjectForm.reset();
            imagePreview.innerHTML = '';
            document.querySelector('[data-section="projects"]').click();
        });

        // Add click handler for "Add New Project" button in projects section
        document.querySelector('.add-btn').addEventListener('click', () => {
            addProjectForm.reset();
            imagePreview.innerHTML = '';
            addProjectForm.removeAttribute('data-editing');
            document.querySelector('.submit-btn').innerHTML = '<i class="fas fa-plus"></i> Add Project';
            document.querySelector('[data-section="add-project"]').click();
        });

        // Handle project form submission
        addProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const title = addProjectForm.querySelector('[name="title"]').value;
                const category = addProjectForm.querySelector('[name="category"]').value;
                const description = addProjectForm.querySelector('[name="description"]').value;
                const technology = addProjectForm.querySelector('[name="technology"]').value;
                const link = addProjectForm.querySelector('[name="link"]').value;
                const detailedDescription = addProjectForm.querySelector('[name="detailedDescription"]').value;
                const newImages = addProjectForm.querySelector('[name="images"]').files;

                if (!title || !category || !description) {
                    throw new Error('Please fill in all required fields');
                }

                const projectData = {
                    id: addProjectForm.dataset.editing || Date.now().toString(),
                    title,
                    category,
                    description,
                    technology,
                    link,
                    detailedDescription,
                    images: [],
                    date: new Date().toISOString()
                };

                // Keep remaining existing images if editing
                if (addProjectForm.dataset.editing) {
                    const existingImages = Array.from(addProjectForm.querySelectorAll('.preview-image'))
                        .map(div => div.dataset.originalImage)
                        .filter(img => img); // Filter out any undefined/null values
                    projectData.images = existingImages;
                }

                // Add new images
                if (newImages.length > 0) {
                    for (const file of newImages) {
                        if (file.size > 5000000) { // 5MB limit
                            throw new Error('Image file size should be less than 5MB');
                        }
                        const base64 = await convertToBase64(file);
                        projectData.images.push(base64);
                    }
                }

                // Show loading state
                const submitBtn = addProjectForm.querySelector('.submit-btn');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                submitBtn.disabled = true;

                // Send to server
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Failed to save project');
                }

                showNotification(
                    addProjectForm.dataset.editing ? 'Project updated successfully!' : 'Project saved successfully!', 
                    'success'
                );
                
                // Reset form and update display
                addProjectForm.reset();
                addProjectForm.removeAttribute('data-editing');
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Project';
                submitBtn.disabled = false;
                imagePreview.innerHTML = '';
                
                // Reset the required attribute on the image input
                addProjectForm.querySelector('[name="images"]').setAttribute('required', '');
                
                // Reload projects and switch to projects section
                await loadProjects();
                document.querySelector('[data-section="projects"]').click();
                
            } catch (error) {
                console.error('Error saving project:', error);
                showNotification(error.message || 'Error saving project', 'error');
            }
        });

        // Convert file to base64
        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Display projects
        function displayProjects() {
            console.log('Displaying projects:', projects); // Debug log
            
            if (!projectsList) {
                console.error('Projects list element not found');
                return;
            }

            if (!projects || projects.length === 0) {
                projectsList.innerHTML = `
                    <div class="no-projects">
                        <i class="fas fa-folder-open"></i>
                        <p>No projects added yet</p>
                    </div>
                `;
                return;
            }

            projectsList.innerHTML = projects.map(project => {
                const categoryDisplay = {
                    'software': 'Software Development',
                    'web': 'Web Development',
                    'mobile': 'Mobile App',
                    'design': 'UI/UX Design'
                }[project.category] || project.category;

                const imageUrl = project.images && project.images.length > 0 
                    ? project.images[0] 
                    : 'https://via.placeholder.com/300x200';
                    
                console.log('Project image URL:', imageUrl); // Debug log

                return `
                    <div class="project-card" data-id="${project.id}">
                        <div class="project-image">
                            <img src="${imageUrl}" 
                                 alt="${project.title}" 
                                 onerror="this.src='https://via.placeholder.com/300x200'">
                        </div>
                        <div class="project-info">
                            <h3>${project.title}</h3>
                            <span class="project-category">${categoryDisplay}</span>
                            <p>${project.description}</p>
                        </div>
                        <div class="project-actions">
                            <button class="edit-btn" onclick="editProject('${project.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="delete-btn" onclick="deleteProject('${project.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            // Remove any existing notifications
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            document.body.appendChild(notification);
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Image preview
        const imageInput = document.querySelector('input[name="images"]');
        const imagePreview = document.querySelector('.image-preview');

        imageInput.addEventListener('change', () => {
            imagePreview.innerHTML = '';
            [...imageInput.files].forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.innerHTML += `
                        <div class="preview-image">
                            <img src="${e.target.result}" alt="Preview">
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            });
        });

        // Initialize displays
        displayProjects();
        updateDashboardStats();

        // Add search functionality
        const searchInput = document.getElementById('projectSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredProjects = projects.filter(project => 
                    project.title.toLowerCase().includes(searchTerm) ||
                    project.description.toLowerCase().includes(searchTerm) ||
                    project.category.toLowerCase().includes(searchTerm)
                );
                
                displayFilteredProjects(filteredProjects);
            });
        }

        function displayFilteredProjects(filteredProjects) {
            projectsList.innerHTML = filteredProjects.length ? filteredProjects.map(project => `
                <div class="project-card" data-id="${project.id}">
                    <div class="project-image">
                        <img src="${project.images[0] || 'https://via.placeholder.com/300x200'}" alt="${project.title}">
                    </div>
                    <div class="project-info">
                        <h3>${project.title}</h3>
                        <span class="project-category">${project.category}</span>
                        <p>${project.description}</p>
                    </div>
                    <div class="project-actions">
                        <button class="edit-btn" onclick="editProject(${project.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="delete-btn" onclick="deleteProject(${project.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('') : `
                <div class="no-projects">
                    <i class="fas fa-search"></i>
                    <p>No projects found</p>
                </div>
            `;
        }

        // Add this function back to admin-panel.html
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                if (!response.ok) {
                    throw new Error('Failed to load projects');
                }
                const data = await response.json();
                console.log('Loaded projects:', data); // Debug log
                projects = data; // Update the global projects variable
                displayProjects();
                await updateDashboardStats(); // Update stats after loading projects
            } catch (error) {
                console.error('Error loading projects:', error);
                showNotification('Error loading projects', 'error');
            }
        }

        // Update the updateDashboardStats function
        async function updateDashboardStats() {
            const totalProjects = document.getElementById('totalProjects');
            const activeProjects = document.getElementById('activeProjects');
            const totalViews = document.querySelector('.stat-card:nth-child(2) p');
            const recentActivity = document.getElementById('recentActivity');

            try {
                // Use the current projects data which includes views
                const views = projects.reduce((sum, project) => sum + (project.views || 0), 0);
                
                // Update stats
                totalProjects.textContent = projects.length;
                activeProjects.textContent = projects.filter(p => !p.archived).length;
                totalViews.textContent = views.toLocaleString();

                // Update recent activity with view counts
                const recentProjects = [...projects]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);

                recentActivity.innerHTML = recentProjects.map(project => `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="activity-details">
                            <h4>${project.title}</h4>
                            <p>
                                Added on ${new Date(project.date).toLocaleDateString()} 
                                <span class="view-count">
                                    <i class="fas fa-eye"></i> ${project.views || 0}
                                </span>
                            </p>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error updating dashboard stats:', error);
            }
        }

        // Add these event listeners at the bottom of your script
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, loading projects...'); // Debug log
            loadProjects(); // Initial load
        });

        // Update more frequently to catch view changes
        setInterval(loadProjects, 5000); // Refresh data every 5 seconds
    </script>
</body>
</html>